<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feeder Button</title>
    <style>
        body {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
        }

        .feeder-button {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 200px;
          height: 50px;
          padding: 10px;
          background-color: green;
          color: white;
          border: 2px solid black;
          cursor: pointer;
          text-align: center;
          line-height: 30px;
          transition: background-color 0.3s ease;
          user-select: none;
          position: relative;
          overflow: hidden;
          font-size: 1em;
        }

        .feeder-button:hover {
          background-color: darkgreen;
        }

        .feeder-button.red {
          background-color: red;
        }

        .timer {
          color: white;
          font-weight: bold;
          margin-left: 10px;
          font-size: 1em;
        }

        .control-buttons {
          display: flex;
          gap: 20px;
          margin-top: 20px;
        }

        .control-button {
          padding: 10px;
          border: 1px solid black;
          background-color: lightgray;
          color: black;
          cursor: pointer;
          font-size: 1em;
          user-select: none;
        }

        .control-button:hover {
          background-color: gray;
        }
    </style>
</head>
<body>

<button id="feederButton" class="feeder-button">Town Feeder
    <div id="timerDisplay" class="timer"></div>
</button>

<div class="control-buttons">
    <button id="startButton" class="control-button">Start</button>
    <button id="stopButton" class="control-button">Stop</button>
    <button id="resetButton" class="control-button">Reset</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

    // Firebase configuration (replace with your own config)
    const firebaseConfig = {
      apiKey: "AIzaSyAy53-F5QZ5a0f9DW9emesit1KA2T7v7Do",
      authDomain: "testt-b241d.firebaseapp.com",
      projectId: "testt-b241d",
      storageBucket: "testt-b241d.appspot.com",
      messagingSenderId: "288476078303",
      appId: "1:288476078303:android:ff06d4a9d5c432f41ac96a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let timerInterval;
    let timerStartTime;
    let lastTimerValue;
    let clickCount = 0;

    const feederButton = document.getElementById('feederButton');
    const timerDisplay = document.getElementById('timerDisplay');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const resetButton = document.getElementById('resetButton');

    const startTimer = () => {
      timerStartTime = Date.now();
      timerInterval = setInterval(() => {
        updateTimer();
        updateFirestore();
      }, 100); // Update every 100 milliseconds
      timerDisplay.style.display = 'block';
    };

    const updateTimer = () => {
      const elapsedSeconds = Math.floor((Date.now() - timerStartTime) / 1000);
      lastTimerValue = elapsedSeconds;
      timerDisplay.textContent = formatTime(elapsedSeconds);
    };

    const updateFirestore = async () => {
      try {
        await setDoc(doc(db, 'feeder', 'button_status'), {
          button_color: feederButton.classList.contains('red') ? 'red' : 'green',
          button_time: lastTimerValue,
          timestamp: Date.now() // Store current timestamp
        });
      } catch (error) {
        console.error("Error updating button status:", error);
      }
    };

    const resetTimer = () => {
      clearInterval(timerInterval);
      timerDisplay.style.display = 'none';
      timerDisplay.textContent = '';
    };

    const saveButtonStatus = async (color, startTime, timestamp) => {
      try {
        await setDoc(doc(db, 'feeder', 'button_status'), {
          button_color: color,
          button_time: startTime,
          timestamp: timestamp || Date.now() // Store the current timestamp
        });
        console.log("Button status saved:", { button_color: color, button_time: startTime, timestamp });
      } catch (error) {
        console.error("Error saving button status:", error);
      }
    };

    const loadButtonStatus = async () => {
      try {
        const docRef = doc(db, 'feeder', 'button_status');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const { button_color, button_time, timestamp } = docSnap.data();
          console.log("Loaded button status:", { button_color, button_time, timestamp });

          // Calculate how much time has passed since the last timestamp
          const currentTime = Date.now();
          const elapsedTimeSinceSave = Math.floor((currentTime - timestamp) / 1000); // Convert ms to seconds

          // If the button was red (timer running)
          if (button_color === 'red' && button_time !== null) {
            // Calculate the new timer value based on the time that passed since the page was closed
            const newTime = button_time + elapsedTimeSinceSave;

            // Set the button to red and start the timer
            feederButton.classList.add('red');
            timerStartTime = Date.now() - (newTime * 1000); // Adjust timer to continue
            startTimer();
          } 
          // If the button was green (timer stopped)
          else if (button_color === 'green' && button_time !== null) {
            feederButton.classList.remove('red');
            timerDisplay.style.display = 'block';
            timerDisplay.textContent = formatTime(button_time);
          }
        }
      } catch (error) {
        console.error("Error loading button status:", error);
      }
    };

    const handleStart = async () => {
      feederButton.classList.add('red');
      startTimer();
      await saveButtonStatus('red', lastTimerValue || 0, Date.now()); // Save with current timestamp
    };

    const handleStop = async () => {
      clearInterval(timerInterval);
      feederButton.classList.remove('red');
      timerDisplay.style.display = 'block';
      timerDisplay.textContent = formatTime(lastTimerValue);
      await saveButtonStatus('green', lastTimerValue, Date.now()); // Save last timer value with timestamp
    };

    const handleReset = async () => {
      resetTimer();
      feederButton.classList.remove('red');
      timerDisplay.style.display = 'none';
      await saveButtonStatus('green', null); // Save reset state
    };

    const formatTime = (seconds) => {
      const hours = Math.floor(seconds / 3600).toString().padStart(2, '0');
      const minutes = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
      const sec = (seconds % 60).toString().padStart(2, '0');
      return `${hours}:${minutes}:${sec}`;
    };

    startButton.addEventListener('click', handleStart);
    stopButton.addEventListener('click', handleStop);
    resetButton.addEventListener('click', handleReset);

    // Load the button status on page load
    loadButtonStatus();
</script>

</body>
</html>
